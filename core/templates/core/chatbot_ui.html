{% extends 'core/base.html' %}
{% block content %}
<style>
.chat-container { height: 500px; overflow-y: scroll; border: 1px solid #ddd; padding: 15px; background: #f8f9fa; }
.message { margin-bottom: 15px; padding: 10px; border-radius: 10px; max-width: 70%; }
.user-message { background: #007bff; color: white; margin-left: auto; text-align: right; }
.bot-message { background: #e9ecef; color: black; }
.crisis-popup { position: fixed; top: 20px; right: 20px; width: 350px; background: #dc3545; color: white; padding: 20px; border-radius: 10px; z-index: 9999; }
</style>

<div class='container-main'>
    <h2>🤖 24/7 AI Mental Health Support</h2>
    <div class='chat-container' id='chatBox'>
        <div class='message bot-message'>
            <p><b>SoulCare AI:</b> Hello! I'm here to support you 24/7. How are you feeling today?</p>
        </div>
    </div>
    
    <div class='mt-3'>
        <form id='chatForm'>
            {% csrf_token %}
            <div class='input-group'>
                <input type='text' id='userMessage' class='form-control' placeholder='Type your message...' required>
                <button type='submit' class='btn btn-primary'>Send</button>
            </div>
        </form>
    </div>
</div>

<div id='crisisPopup' class='crisis-popup' style='display:none;'>
    <h5>🚨 We're Here For You</h5>
    <p>We detected you might need immediate support. Here are some calming activities:</p>
    <div id='crisisActivities'></div>
    <button onclick='this.parentElement.style.display="none"' class='btn btn-light btn-sm mt-2'>Close</button>
</div>

<script>
document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = document.getElementById('userMessage').value;
    const chatBox = document.getElementById('chatBox');
    
    // Show user message
    chatBox.innerHTML += \<div class='message user-message'><b>You:</b> \</div>\;
    document.getElementById('userMessage').value = '';
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // Send to AI
    const response = await fetch('/chatbot/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
        body: JSON.stringify({message: message})
    });
    
    const data = await response.json();
    
    // Show AI response
    chatBox.innerHTML += \<div class='message bot-message'><b>SoulCare AI:</b> \</div>\;
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // Show crisis popup if needed
    if (data.severity && data.severity !== 'low') {
        const popup = document.getElementById('crisisPopup');
        const activities = document.getElementById('crisisActivities');
        activities.innerHTML = data.recommendations.map(r => 
            \<a href='\' target='_blank' class='btn btn-light btn-sm mb-1 w-100'>\</a>\
        ).join('');
        popup.style.display = 'block';
    }
});
</script>
{% endblock %}
